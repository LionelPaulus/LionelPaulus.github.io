<!DOCTYPE html>
<html lang="en">

<head>
    <title>Star Wars : Space Racers</title>
    <meta name="viewport" content="width=device-width,user-scalable=no" />
</head>

<body>
    <div id="content">
        <ul>
            <li>acceleration x:
                <span id="accelerationX"></span>g</li>
            <li>acceleration y:
                <span id="accelerationY"></span>g</li>
            <li>acceleration z:
                <span id="accelerationZ"></span>g</li>
            <br><button id="calibrate">Calibrate</button>
        </ul>
    </div>

    <script src="http://192.168.1.15:3000/socket.io/socket.io.js"></script>
    <script src="scripts/NoSleep.min.js"></script>
    <script type="text/javascript">
        if (window.DeviceMotionEvent !== undefined) { // If device has accelerometer support
            // Actually, it doesn't work but we are waiting the Chrome update
            document.keepScreenAwake = true;

            // Node server connect
            var socket = io.connect('192.168.1.15:3000');
            var datas = {};
            socket.emit('gyroscope');

            // Variables
            var calibrate = document.querySelector("#calibrate"),
                invert = false,
                x = 0,
                y = 0,
                z = 0;

            // Enable vibration support
            navigator.vibrate = navigator.vibrate || navigator.webkitVibrate || navigator.mozVibrate || navigator.msVibrate;

            // On tap - fire
            document.addEventListener("touchstart", function(){
                socket.emit('fire');
            });

            // Vibrate
            socket.on('vibrate', function(time) {
                navigator.vibrate(time);
            });

            window.ondevicemotion = function(e) {
                x = event.accelerationIncludingGravity.x;
                y = event.accelerationIncludingGravity.y;
                z = event.accelerationIncludingGravity.z;

                // Adapt for iPhone & iPod
                if((navigator.userAgent.match(/iPhone/i)) || (navigator.userAgent.match(/iPod/i))) {
                    z = -z;
                }

                // If phone is handed in the other side
                if(invert){
                    x = -x;
                    y = -y;
                }

                // Send acceleration positions to server
                socket.emit('position', JSON.stringify({
                    x: x,
                    y: y,
                    z: z
                }));

                // For tests only
                document.getElementById("accelerationX").innerHTML = Math.floor(x);
                document.getElementById("accelerationY").innerHTML = Math.floor(y);
                document.getElementById("accelerationZ").innerHTML = Math.floor(z);
            };

            // When the player starts the game
            calibrate.addEventListener("click", function(){
                // Enable noSleep
                var noSleep = new NoSleep();
                noSleep.enable();

                // Verify how he is holding the phone
                if(x < 0){
                    invert = true;
                }
            });
        }
    </script>

</body>

</html>
